name: Release Binaries

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to build (e.g., v0.3.0)'
        required: true

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  RELEASE_TAG: ${{ github.event.release.tag_name || github.event.inputs.tag }}

jobs:
  build:
    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: runner-mgr-linux-x64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: runner-mgr-macos-arm64
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}

      # macOS: Import certificate and sign binary
      - name: Import signing certificate
        if: runner.os == 'macOS'
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

      - name: Sign binary
        if: runner.os == 'macOS'
        run: |
          codesign --sign "Developer ID Application" \
            --options runtime \
            --timestamp \
            target/${{ matrix.target }}/release/runner-mgr

      - name: Notarize binary
        if: runner.os == 'macOS'
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Create zip for notarization
          cd target/${{ matrix.target }}/release
          zip runner-mgr.zip runner-mgr

          # Submit for notarization and wait
          xcrun notarytool submit runner-mgr.zip \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

          # Clean up zip
          rm runner-mgr.zip

      - name: Package binary
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/runner-mgr dist/
          cd dist
          tar czf ../${{ matrix.artifact }}.tar.gz runner-mgr
          cd ..
          shasum -a 256 ${{ matrix.artifact }}.tar.gz > ${{ matrix.artifact }}.tar.gz.sha256

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ matrix.artifact }}.tar.gz
            ${{ matrix.artifact }}.tar.gz.sha256

  update-homebrew:
    name: Update Homebrew tap
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download checksums from release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download ${{ env.RELEASE_TAG }} \
            --repo ${{ github.repository }} \
            --pattern "*.sha256" \
            --dir checksums

      - name: Parse checksums
        id: checksums
        run: |
          MACOS_SHA256=$(cat checksums/runner-mgr-macos-arm64.tar.gz.sha256 | awk '{print $1}')
          LINUX_SHA256=$(cat checksums/runner-mgr-linux-x64.tar.gz.sha256 | awk '{print $1}')
          VERSION="${{ env.RELEASE_TAG }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix
          echo "macos_sha256=$MACOS_SHA256" >> $GITHUB_OUTPUT
          echo "linux_sha256=$LINUX_SHA256" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Clone homebrew-tap
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/patrickserrano/homebrew-tap.git

      - name: Update formula
        env:
          VERSION: ${{ steps.checksums.outputs.version }}
          MACOS_SHA256: ${{ steps.checksums.outputs.macos_sha256 }}
          LINUX_SHA256: ${{ steps.checksums.outputs.linux_sha256 }}
        run: |
          cd homebrew-tap/Formula
          cat > runner-mgr.rb << EOF
          class RunnerMgr < Formula
            desc "CLI tool for managing GitHub Actions self-hosted runners with a TUI dashboard"
            homepage "https://github.com/patrickserrano/runner-dashboard"
            version "${VERSION}"
            license "MIT"

            on_macos do
              on_arm do
                url "https://github.com/patrickserrano/runner-dashboard/releases/download/v#{version}/runner-mgr-macos-arm64.tar.gz"
                sha256 "${MACOS_SHA256}"
              end
            end

            on_linux do
              on_intel do
                url "https://github.com/patrickserrano/runner-dashboard/releases/download/v#{version}/runner-mgr-linux-x64.tar.gz"
                sha256 "${LINUX_SHA256}"
              end
            end

            def install
              bin.install "runner-mgr"
            end

            test do
              assert_match "runner-mgr", shell_output("#{bin}/runner-mgr --version")
            end
          end
          EOF
          # Fix indentation (heredoc adds leading spaces)
          sed -i 's/^          //' runner-mgr.rb

      - name: Commit and push
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/runner-mgr.rb
          git commit -m "Update runner-mgr to v${{ steps.checksums.outputs.version }}"
          git push
